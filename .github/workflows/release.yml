name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Extract changelog for this release
        id: changelog
        run: |
          # ä»Ž CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          awk '/## \['${{ env.VERSION }}']/{flag=1} flag{print} /^---$/{if(flag)exit}' CHANGELOG.md > release_notes.md

          # æ·»åŠ ä¸‹è½½è¯´æ˜Ž
          cat >> release_notes.md << 'EOF'

          ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž

          | æ–‡ä»¶ | è¯´æ˜Ž | ä¸‹è½½ |
          |------|------|------|
          | `voice-coding-*.apk` | Android å®‰è£…åŒ… | æ‰‹æœºä¸‹è½½å®‰è£… |
          | `voice-coding-*.exe` | Windows ç”µè„‘ç«¯ | ç”µè„‘ä¸‹è½½è¿è¡Œ |

          ### ðŸš€ å¿«é€Ÿå¼€å§‹

          1. **ç”µè„‘ç«¯**ï¼šä¸‹è½½ EXE æ–‡ä»¶ï¼Œç›´æŽ¥è¿è¡Œ
          2. **æ‰‹æœºç«¯**ï¼šä¸‹è½½ APK æ–‡ä»¶ï¼Œå®‰è£…åˆ°æ‰‹æœº
          3. **è¿žæŽ¥**ï¼š
             - å¼€å¯ Windows ç§»åŠ¨çƒ­ç‚¹
             - æ‰‹æœºè¿žæŽ¥ç”µè„‘çƒ­ç‚¹
             - æ‰“å¼€ APKï¼Œè‡ªåŠ¨è¿žæŽ¥ç”µè„‘ âœ…

          ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚

          - **Windows**ï¼šWindows 10/11 (64ä½)
          - **Android**ï¼šAndroid 5.0+ (API 21+)

          EOF

          # è½¬ä¹‰ä¸º JSON æ ¼å¼ä¾› GitHub API ä½¿ç”¨
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Voice Coding ${{ env.VERSION }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
